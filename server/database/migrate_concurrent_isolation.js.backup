// /**
//  * æ•°æ®åº“è¿ç§»è„šæœ¬ - å¤šç”¨æˆ·å¹¶å‘éš”ç¦»æ”¯æŒ
//  * æ–‡ä»¶: server/database/migrate_concurrent_isolation.js
//  */

// const fs = require('fs');
// const path = require('path');
// const Database = require('better-sqlite3');

// class ConcurrentIsolationMigration {
//   constructor() {
//     const dbPath = path.join(__dirname, 'knowledge_platform.db');
//     this.db = new Database(dbPath);
//     this.db.pragma('journal_mode = WAL');
//     this.db.pragma('foreign_keys = ON');
//   }

//   async migrate() {
//     console.log('ğŸ”„ å¼€å§‹å¤šç”¨æˆ·å¹¶å‘éš”ç¦»æ•°æ®åº“è¿ç§»...');
    
//     try {
//       // å¼€å§‹äº‹åŠ¡
//       const transaction = this.db.transaction(() => {
//         // è¯»å–å¹¶æ‰§è¡Œè¿ç§»SQL
//         const schemaPath = path.join(__dirname, 'concurrent_isolation_schema.sql');
//         const schemaSql = fs.readFileSync(schemaPath, 'utf8');
        
//         // åˆ†å‰²SQLè¯­å¥å¹¶æ‰§è¡Œ
//         const statements = schemaSql
//           .split(';')
//           .map(stmt => stmt.trim())
//           .filter(stmt => stmt.length > 0);
        
//         for (const statement of statements) {
//           try {
//             this.db.exec(statement);
//             console.log(`âœ… æ‰§è¡ŒæˆåŠŸ: ${statement.substring(0, 50)}...`);
//           } catch (error) {
//             if (error.message.includes('already exists')) {
//               console.log(`âš ï¸ å·²å­˜åœ¨: ${statement.substring(0, 50)}...`);
//             } else {
//               throw error;
//             }
//           }
//         }
        
//         // åˆå§‹åŒ–é»˜è®¤æ•°æ®
//         this.initializeDefaultData();
//       });
      
//       transaction();
      
//       console.log('âœ… æ•°æ®åº“è¿ç§»å®Œæˆï¼');
      
//       // éªŒè¯è¿ç§»ç»“æœ
//       this.validateMigration();
      
//     } catch (error) {
//       console.error('âŒ æ•°æ®åº“è¿ç§»å¤±è´¥:', error);
//       throw error;
//     } finally {
//       this.db.close();
//     }
//   }

//   initializeDefaultData() {
//     console.log('ğŸ“ åˆå§‹åŒ–é»˜è®¤æ•°æ®...');
    
//     try {
//       // æ£€æŸ¥æ˜¯å¦å·²æœ‰AIè®¾ç½®è®°å½•
//       const existingSettings = this.db.prepare('SELECT COUNT(*) as count FROM ai_model_settings').get();
      
//       if (existingSettings.count === 0) {
//         // æ’å…¥é»˜è®¤AIè®¾ç½®
//         this.db.prepare(`
//           INSERT INTO ai_model_settings (
//             version, model_type, model_name, api_endpoint, 
//             model_config, is_active, created_by, reason
//           ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
//         `).run(
//           1,
//           'deepseek',
//           'deepseek-chat',
//           'https://api.deepseek.com',
//           JSON.stringify({
//             temperature: 0.7,
//             max_tokens: 2000,
//             top_p: 0.9
//           }),
//           1,
//           1, // å‡è®¾ç®¡ç†å‘˜ç”¨æˆ·IDä¸º1
//           'ç³»ç»Ÿåˆå§‹åŒ–é»˜è®¤è®¾ç½®'
//         );
        
//         console.log('âœ… é»˜è®¤AIè®¾ç½®å·²åˆ›å»º');
//       }
      
//       // æ£€æŸ¥å¹¶åˆ›å»ºç´¢å¼•
//       this.createOptimizationIndexes();
      
//     } catch (error) {
//       console.error('âŒ åˆå§‹åŒ–é»˜è®¤æ•°æ®å¤±è´¥:', error);
//       throw error;
//     }
//   }

//   createOptimizationIndexes() {
//     console.log('ğŸ”§ åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ç´¢å¼•...');
    
//     const indexes = [
//       'CREATE INDEX IF NOT EXISTS idx_user_sessions_active ON user_sessions(user_id, expires_at)',
//       'CREATE INDEX IF NOT EXISTS idx_file_refs_active ON file_references(file_id, reference_type)',
//       'CREATE INDEX IF NOT EXISTS idx_learning_progress ON learning_session_details(user_id, tag_id, updated_at)',
//       'CREATE INDEX IF NOT EXISTS idx_quiz_progress ON quiz_session_details(user_id, tag_id, completed_at)',
//       'CREATE INDEX IF NOT EXISTS idx_audit_recent ON audit_logs(timestamp DESC)',
//       'CREATE INDEX IF NOT EXISTS idx_notifications_unread ON system_notifications(target_type, target_id, created_at)'
//     ];
    
//     for (const index of indexes) {
//       try {
//         this.db.exec(index);
//         console.log(`âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ: ${index.match(/idx_\w+/)[0]}`);
//       } catch (error) {
//         if (!error.message.includes('already exists')) {
//           console.warn(`âš ï¸ ç´¢å¼•åˆ›å»ºå¤±è´¥: ${error.message}`);
//         }
//       }
//     }
//   }

//   validateMigration() {
//     console.log('ğŸ” éªŒè¯è¿ç§»ç»“æœ...');
    
//     const expectedTables = [
//       'user_sessions',
//       'ai_model_settings',
//       'ai_settings_history',
//       'file_references',
//       'file_locks',
//       'learning_session_details',
//       'quiz_session_details',
//       'concurrency_controls',
//       'system_notifications',
//       'audit_logs'
//     ];
    
//     const tables = this.db.prepare(`
//       SELECT name FROM sqlite_master 
//       WHERE type='table' AND name NOT LIKE 'sqlite_%'
//     `).all().map(row => row.name);
    
//     for (const table of expectedTables) {
//       if (tables.includes(table)) {
//         const count = this.db.prepare(`SELECT COUNT(*) as count FROM ${table}`).get();
//         console.log(`âœ… è¡¨ ${table} å­˜åœ¨ï¼ŒåŒ…å« ${count.count} æ¡è®°å½•`);
//       } else {
//         console.error(`âŒ è¡¨ ${table} ä¸å­˜åœ¨`);
//       }
//     }
    
//     // æ£€æŸ¥AIè®¾ç½®
//     const aiSettings = this.db.prepare('SELECT version, model_type, is_active FROM ai_model_settings WHERE is_active = 1').get();
//     if (aiSettings) {
//       console.log(`âœ… æ´»è·ƒAIè®¾ç½®: ç‰ˆæœ¬ ${aiSettings.version}, æ¨¡å‹ ${aiSettings.model_type}`);
//     } else {
//       console.error('âŒ æ²¡æœ‰æ‰¾åˆ°æ´»è·ƒçš„AIè®¾ç½®');
//     }
//   }
// }

// // åˆ›å»ºç®¡ç†æ¥å£
// const migrationManager = {
//   async runMigration() {
//     const migration = new ConcurrentIsolationMigration();
//     await migration.migrate();
//   },

//   async rollback() {
//     console.log('ğŸ”„ æ‰§è¡Œå›æ»šæ“ä½œ...');
//     const dbPath = path.join(__dirname, 'knowledge_platform.db');
//     const db = new Database(dbPath);
    
//     try {
//       const transaction = db.transaction(() => {
//         const tablesToDrop = [
//           'audit_logs',
//           'system_notifications',
//           'concurrency_controls',
//           'quiz_session_details',
//           'learning_session_details',
//           'file_locks',
//           'file_references',
//           'ai_settings_history',
//           'ai_model_settings',
//           'user_sessions'
//         ];
        
//         for (const table of tablesToDrop) {
//           try {
//             db.exec(`DROP TABLE IF EXISTS ${table}`);
//             console.log(`âœ… åˆ é™¤è¡¨: ${table}`);
//           } catch (error) {
//             console.warn(`âš ï¸ åˆ é™¤è¡¨å¤±è´¥: ${table} - ${error.message}`);
//           }
//         }
//       });
      
//       transaction();
//       console.log('âœ… å›æ»šå®Œæˆ');
      
//     } catch (error) {
//       console.error('âŒ å›æ»šå¤±è´¥:', error);
//       throw error;
//     } finally {
//       db.close();
//     }
//   },

//   async checkStatus() {
//     console.log('ğŸ” æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...');
//     const dbPath = path.join(__dirname, 'knowledge_platform.db');
//     const db = new Database(dbPath);
    
//     try {
//       const tables = db.prepare(`
//         SELECT name FROM sqlite_master 
//         WHERE type='table' AND name NOT LIKE 'sqlite_%'
//         ORDER BY name
//       `).all();
      
//       console.log('ğŸ“‹ æ•°æ®åº“è¡¨åˆ—è¡¨:');
//       for (const table of tables) {
//         const count = db.prepare(`SELECT COUNT(*) as count FROM ${table.name}`).get();
//         console.log(`  ${table.name}: ${count.count} æ¡è®°å½•`);
//       }
      
//       // æ£€æŸ¥AIè®¾ç½®çŠ¶æ€
//       try {
//         const aiSettings = db.prepare('SELECT * FROM ai_model_settings WHERE is_active = 1').get();
//         if (aiSettings) {
//           console.log(`ğŸ¤– å½“å‰AIè®¾ç½®: ${aiSettings.model_type} v${aiSettings.version}`);
//         }
//       } catch (error) {
//         console.log('âš ï¸ AIè®¾ç½®è¡¨ä¸å­˜åœ¨');
//       }
      
//     } catch (error) {
//       console.error('âŒ æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
//     } finally {
//       db.close();
//     }
//   }
// };

// // å‘½ä»¤è¡Œæ”¯æŒ
// if (require.main === module) {
//   const command = process.argv[2];
  
//   switch (command) {
//     case 'migrate':
//       migrationManager.runMigration().catch(console.error);
//       break;
//     case 'rollback':
//       migrationManager.rollback().catch(console.error);
//       break;
//     case 'status':
//       migrationManager.checkStatus().catch(console.error);
//       break;
//     default:
//       console.log('ä½¿ç”¨æ–¹æ³•:');
//       console.log('  node migrate_concurrent_isolation.js migrate   # æ‰§è¡Œè¿ç§»');
//       console.log('  node migrate_concurrent_isolation.js rollback  # å›æ»šè¿ç§»');
//       console.log('  node migrate_concurrent_isolation.js status    # æ£€æŸ¥çŠ¶æ€');
//   }
// }

// module.exports = migrationManager;
